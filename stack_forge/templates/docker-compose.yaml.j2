# templates/docker-compose.yaml.j2
version: '3.8'

services:
  
  {% if services.postgres %}
  postgres:
    # 1. ì´ë¯¸ì§€ ì˜¤ë²„ë¼ì´ë“œ (ì—†ìœ¼ë©´ 'postgres:15' ì‚¬ìš©)
    image: {{ services.postgres.image | default('postgres:15') }}
    container_name: stack_forge_postgres # ğŸ‘ˆ ì´ë¦„ ë³€ê²½
    
    # 2. í¬íŠ¸ ì˜¤ë²„ë¼ì´ë“œ (ì—†ìœ¼ë©´ service_config.postgres.port ì‚¬ìš©)
    ports:
      {% for port_mapping in services.postgres.ports | default([service_config.postgres.port ~ ':5432']) %}
      - "{{ port_mapping }}"
      {% endfor %}
      
    environment:
      POSTGRES_USER: "{{ service_config.postgres.user }}"
      POSTGRES_PASSWORD: "{{ service_config.postgres.password }}"
      POSTGRES_DB: "{{ service_config.postgres.db_name | default('stack_forge_db') }}" # ğŸ‘ˆ ì´ë¦„ ë³€ê²½
      
    # 3. ë³¼ë¥¨ ì˜¤ë²„ë¼ì´ë“œ (ì—†ìœ¼ë©´ 'stack_forge_postgres_data' ì‚¬ìš©)
    volumes:
      {% for volume_mapping in services.postgres.volumes | default(['stack_forge_postgres_data:/var/lib/postgresql/data']) %} # ğŸ‘ˆ ì´ë¦„ ë³€ê²½
      - "{{ volume_mapping }}"
      {% endfor %}
  {% endif %}


  {% if services.dbt %}
  dbt:
    image: {{ services.dbt.image | default('ghcr.io/dbt-labs/dbt-postgres:1.7-latest') }}
    container_name: stack_forge_dbt # ğŸ‘ˆ ì´ë¦„ ë³€ê²½
    
    volumes:
      {% for volume_mapping in services.dbt.volumes | default([dbt_config.project_dir ~ ':/usr/app']) %}
      - "{{ volume_mapping }}"
      {% endfor %}
      
    # dbt ì»¨í…Œì´ë„ˆê°€ postgresë³´ë‹¤ ë¨¼ì € ëœ¨ë©´ ì ‘ì† ì‹¤íŒ¨í•˜ë¯€ë¡œ, postgresê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ë„ë¡ í•¨
    # (docker-compose v2.1+ í•„ìš”)
    depends_on:
      postgres:
        condition: service_healthy # ğŸ‘ˆ (ì£¼ì˜) Postgresì— healthcheck ì¶”ê°€ í•„ìš”
        
    command: ["tail", "-f", "/dev/null"]
  {% endif %}

  
  {% if services.airbyte %}
  # (AirbyteëŠ” ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆê°€ í•„ìš”í•˜ë¯€ë¡œ, ìš°ì„  ê°„ë‹¨í•œ í”Œë ˆì´ìŠ¤í™€ë”ë§Œ ë‘¡ë‹ˆë‹¤)
  # (í–¥í›„ docker-compose.yaml.j2ì— airbyte-webapp, server, db ë“±ì„ ì¶”ê°€í•´ì•¼ í•¨)
  airbyte-placeholder:
    image: hello-world
    container_name: stack_forge_airbyte_placeholder
  {% endif %}


# -------------------------------------------------------------------
# ë³¼ë¥¨ ì •ì˜
# -------------------------------------------------------------------
volumes:
  {% if services.postgres and not services.postgres.volumes %}
  stack_forge_postgres_data: # ğŸ‘ˆ ì´ë¦„ ë³€ê²½
  {% endif %}